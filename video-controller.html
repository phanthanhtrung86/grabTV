<!-- This is a Node+WebSocket powered demo to sync videos
     across different browsers. This file is the client,
     the other one is the Node server. Powered by Node and
     http://github.com/miksago/node-websocket-server -->

<style>
  .inactive { display: none; }
  .active { display: block; }
  
  @font-face {
	/* typeface: Xenon2 http://www.splintered.co.uk/experiments/61/ */
	font-family: "Xenon2";
	src: url(xenon2.ttf);
}

html { background: #eee; }
h1 { font-size: 0.7em; margin: 0; padding: 0; }

body {
	background: #eee;
	font-family: "Helvetica Neue", Helvetica, Arial, sans-serif;
	font-size: 0.9em;
	line-height: 1.2;
	color: #222;
	padding: 0; margin: 0.25em;
}

a { color: #227; }

small { font-size: 0.75em; }

video {
	display: block; /* styling shim for older browsers */
	border: 5px #ddd solid;
	border-radius: 5px;
}

#controls {
	position: absolute;
	bottom: 20px;
	left: 113px;
	border-radius: 5px;
	border: 1px #333 solid;
	background: #000 url(gradient.png) repeat-x top left;
	width: 200px;
	height: 31px;
	opacity: 0.3;
	-o-transition: all 0.5s ease-in-out;
	-webkit-transition: all 0.5s ease-in-out;
	-moz-transition: all 0.5s ease-in-out;
	transition: all 0.5s ease-in-out;
}

#controls:hover { 
	border-color: #555;
	opacity: 0.85;
}

#controls button {
	position: absolute;
	top: 8px;
	left: 8px;
	width: 15px;
	height: 15px;
	padding: 0;
	margin: 0;
	border: none;
	background: transparent;
}

#controls #display {
	position: absolute;
	top: 6px;
	left: 45px;
	padding: 0;
	margin: 0;
	color: #fff;
	font-family: "Xenon2", sans-serif;
	font-size: 16px;
}

#controls #volume {
	position: absolute;
	top: 6px;
	right: 8px;
	width: 50px;
	height: 15px;
}

#controls #volumeicon {
	position: absolute;
	top: 8px;
	right: 62px;
}

#chooser, #chooser li { list-style: none; margin: 0; padding: 0; }
#chooser { margin-top: 1em; }
#chooser li { float: left; }
#chooser button { background: none; border: none; margin: 0 4px; padding: 0;
	opacity: 0.5; 	
	-o-transition: all 0.3s ease-in-out;
	-webkit-transition: all 0.3s ease-in-out;
	-moz-transition: all 0.3s ease-in-out;
	transition: all 0.3s ease-in-out;
}
#chooser button:focus, #chooser button:hover { opacity: 1; }

#credits { clear:left; padding: 0.25em 0 0 0; }
#credits p { margin: 0; padding: 0; }
small { font-size: 0.5em; }
  
  
  
  
</style>

<script>

	"use strict";
	var controller = null;
	window.onload = function() {

    var connection = new WebSocket('ws://localhost:8888');
	if (connection == null)
		//alert("Message is sent..."+connection);
    connection.onopen = function () {  
		//alert("open..."+connection);
	};
	connection.onerror = function (error) {
        // just in there were some problems with conenction...
        //alert("error.."+error.toString());
    };
	var threshold = 5;

    var video = $_("video");
    video.addEventListener("timeupdate", function() {
		
		if(Math.floor(video.currentTime % threshold) == 0)
			connection.send("timestamp " + video.currentTime);
		
    }, true);
	
	video.addEventListener("play", function() {
			connection.send("play " + video.currentTime);
    }, true);
    video.addEventListener("pause", function() {
		connection.send("pause "+video.currentTime);
    }, true);
	/*video.addEventListener("seeked", function() {
		connection.send("seeked "+video.currentTime);
    }, true);*/
	
	    // most important part - incoming messages
    connection.onmessage = function (message) {
	/*
		var matches;
		//matches = message.data.match(/^control (.+)$/);
		//alert("controller.."+matches[1]);
		  if (matches = message.data.match(/^control (.+)$/)) {
			$_("#controller").innerHTML = matches[1];
			//alert("controller.."+matches[1]);
		  } else if (matches = message.data.match(/^userCount (.+)$/)) {
			// $_("#userCount").innerHTML = matches[1];
			document.getElementById("userCount").innerHTML = matches[1];
			//alert("usercount.."+matches[1]); ok
		  }else if (matches = message.data.match(/^timestamp (.+)$/)) {
		  //alert("timestamp la:" +matches[0]);
		  //if(matches[0]=="timestamp")
		  
			if (!iAmControlling()){
			var estimatedTimeOnMaster = parseInt(matches[1])+1;
			video.currentTime = estimatedTimeOnMaster;
			if (Math.abs(estimatedTimeOnMaster-video.currentTime)>2)
			  video.currentTime = estimatedTimeOnMaster;
			if (video.paused){
			//alert("timestamp la "+parseInt(matches[1]));
				video.play();
			}
			}
      } else if (matches = message.data.match(/^pause (.+)$/)) {
			video.currentTime = matches[1];
			video.pause();
			//alert("paused.."+matches[1]);
		  } */
		  
		  
		 var matches;
		matches = message.data.split(/\s/g);
		switch (matches[0]){
		case "control":
			$_("#controller").innerHTML = matches[1];
			break;
		case "userCount":
			document.getElementById("userCount").innerHTML = matches[1];
			break;
		
		case "pause":
			//video.currentTime = matches[1];
			video.pause();
			//alert("paused.."+matches[1]);
			break;;
		case "timestamp":
			if (iAmControlling())
				return;
			var estimatedTimeOnMaster = parseInt(matches[1])+1;
			video.currentTime = estimatedTimeOnMaster;
			if (Math.abs(estimatedTimeOnMaster-video.currentTime)>5)
			  video.currentTime = estimatedTimeOnMaster;
			if (video.paused){
				video.play();
			}
			break;
		}
	  };
     	 
    
/*
    $_("#takeControl").onclick = function(ev) {
      //conn.send("control "+$_("#name").value);
	  //alert("control "+$_("#name").value);
	  $_("#controller").innerHTML = $_("#name").value;
	  connection.send("control "+$_("#name").value);
	  //connection.send(JSON.stringify({ type:'control', data: $_("#name").value}));
	  
		
    };*/
	
/*	
    $_("#leave").onclick = function() {
		connection.send("pause "+video.currentTime);
      connection.close();

    };
	*/
	//alert("chooser button");
	
	var b = document.querySelectorAll('#chooser button');
	//var b = document.querySelectorAll("button.nut");
	//alert("chooser button" + b.length);
	
	
	
	
	
	for(var i = 0; i<b.length; i++) {
		//alert("chooser button" + i);
			b[i].addEventListener('click',function(e) {
			
			// We are going to update the value of number of user
			
			
			
			
			
			//alert("chooser button" + b.length);
				var v = document.getElementById('video');

				/* kludge to get Safari to behave... */
				var targ = e.target;
				if (targ.tagName != 'BUTTON') { targ = targ.parentNode; }

				/*if (v.canPlayType("video/ogg") == 'maybe' || v.canPlayType("video/ogg") == 'probably') {
					v.src = targ.getAttribute('data-file')+'.ogv';
				} else if (v.canPlayType("video/mp4") == 'maybe' || v.canPlayType("video/mp4") == 'probably') {
					v.src = targ.getAttribute('data-file')+'.mp4';
					alert("source" + v.src);
				}*/
				v.src = targ.getAttribute('data-file')+'.mp4';
				//alert(targ.getAttribute('data-file')+'.mp4');
		connection.send("control " + targ.getAttribute('data-file')+'.mp4');
				$_("#controller").innerHTML="Channel "+  targ.getAttribute('data-file');
				
				
				//alert("source" + v.src);
				v.load();
				/* small kludge to force video element to fire the "paused" event correctly and change the play/pause button */
				v.play();
				if (video.paused){
				video.play();
			}
				//v.pause();
			},true);
		}
	/*
	// connection to calculate the number of client
	var conn;
	conn = io.connect('http://localhost:8000');
	conn.on('message', function (ev) {
      var matches;
	  
      if (matches = ev.data.match(/^userCount (.+)$/)) {
	  alert("matches..."+matches[1]);
        document.getElementById("userCount").innerHTML = matches[1];
      }
    });*/
};

function iAmControlling() {
	
  return 1==1;
}

function $_(sel) {
  return document.querySelector(sel);
}


</script>


<div id="room" class="active">
 
  <p>Channel Controller: <span id="controller">---</span></p>
   <p>Users: <span id="userCount"></span></p>
  <p><video id="video" src="videos/windowsill.mp4" controls></video></p>
</div>



<ul id="chooser">
<li><button id="windowsill" data-file="videos/windowsill"><img src="thumbs/windowsill.jpg" width="100" height="100" alt="Windowsill of lost memories"></button></li>
<li><button id="garden1" class="nut" data-file="videos/garden1"><img src="thumbs/garden1.jpg" width="100" height="100" alt="Garden serenity part 1"></button></li>
<li><button id="fridge" class="nut" data-file="videos/fridge"><img src="thumbs/fridge.jpg" width="100" height="100" alt="Fridge magnet world tour"></button></li>
<li><button id="garden2" class="nut" data-file="videos/garden2"><img src="thumbs/garden2.jpg" width="100" height="100" alt="Garden serenity part 2"></button></li>
</ul>
